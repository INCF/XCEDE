<?xml version="1.0" encoding="UTF-8"?>
<chapter id="chapter.hierarchy">
  <title>Experiment Hierarchy</title>

  <section>
    <title>Overview</title>
    <para>As illustrated in <xref linkend='hierarchy.levels'/>, the XCEDE experiment hierarchy consists of several <emphasis>levels</emphasis> representing divisions of experiment data at various granularities.  Elements at each level contain level-specific "info" elements, whose schema types may be derived to store experiment-specific or data modality-specific metadata.  The linking mechanism between levels is flexible enough to support the omission of levels if the schema user finds them unnecessary.</para>

    <figure id="hierarchy.levels">
      <title>XCEDE hierarchy</title>
      <mediaobject>
        <imageobject><imagedata fileref="images/hierarchy_levels.svg" format="asvg" width="6in"/> </imageobject>
      </mediaobject>
    </figure>

    <section>
      <title>Hierarchy Levels</title>
      <para>In the typical intended usage, a <emphasis>project</emphasis> is the top-level division of experiment data, and represents a research project which collects and analyzes data from one or more <emphasis>subjects</emphasis> which are divided (within the project) into <emphasis>subject groups</emphasis>.  A subject may be a member of multiple research projects, and it is the subject group that maintains and distinguishes the mappings between subjects and research projects.</para>
      <para>A <emphasis>visit</emphasis> may represent a subject's appearance at an experiment "site" (for collaborative projects, this could be the institution or lab at which the data is being collected or analyzed).  A visit, may be further subdivided into one or more <emphasis>studies</emphasis>, each of would consist of one or more data collection <emphasis>episodes</emphasis>.</para>
      <para>Visit and study are more or less arbitrary divisions of the data that exist for convenience, and do not in themselves have any inherent meaning as far as the schema is concerned.  However, an episode is intended to represent a unit of data collection over a given time interval, and should contain one or more data <emphasis>acquisitions</emphasis>, which should be understood to occur simultaneously over the duration of the episode.  So, for example, an episode in an fMRI study may encapsulate the acquisition of a time-series of volume images from an MR scanner, as well as other acquisitions of behavioral or physiological data; all these (simultaneous) acquisitions would be stored as part of the same episode.</para>
      <para>It would be natural to represent the experiment hierarchy as described as a traditional XML hierarchy, where higher-level elements encapsulate lower-level elements as child elements.  However, in XCEDE, all level elements (<literal>&lt;project&gt;</literal>, <literal>&lt;visit&gt;</literal>, etc.) are stored as children of the root <literal>&lt;XCEDE&gt;</literal> element.   Links between levels are implicit in the level IDs assigned to each element and propagated to elements in lower levels.  One advantage of this approach is to allow users of the schema to omit levels merely by omitting the unnecessary elements and IDs/links.  Applications are also easier to write because all major elements are stored in the same place (under the XCEDE root element).</para>
    </section>

    <section>
      <title>IDs and Linking</title>
      <para>Any level element can be the target of a link from another element.  In addition, most level elements are implicitly linked to "ancestor" level elements.  Both these types of links are created by specifying one or more <emphasis>level IDs</emphasis> that together uniquely describe a target level element.</para>
      <para>Every level element has a set of these level IDs, composed of the element's own <literal>ID</literal> attribute, plus its "ancestor" ID attributes, indicating which higher-level elements have this element in their scope.  For example, the <literal>&lt;visit&gt;</literal> element contains <literal>subjectGroupID</literal>, <literal>subjectID</literal>, and <literal>projectID</literal> attributes.</para>
      <para>For example, a link to a visit element may specify <literal>visitID</literal>, <literal>subjectID</literal>, <literal>subjectGroupID</literal>, and <literal>projectID</literal> attributes, and a <literal>level</literal> attribute with the value <literal>visit</literal>, indicating that this link is to a visit element.  An application resolving this link will search for a visit element in the XCEDE 2.0 dataset whose attributes match those specified in the link (the <literal>visitID</literal> attribute is matched against the <literal>ID</literal> attribute in the visit element).  Level ID attributes not specified in the link should match any value, but a link must specify enough of these IDs match at most one level element.</para>
      <para>The elements that can link to any level element are <literal>&lt;catalog&gt;</literal>, <literal>&lt;resource&gt;</literal>, and <literal>&lt;data&gt;</literal> (children of the <literal>&lt;XCEDE&gt;</literal> root element), <literal>&lt;inputRef&gt;</literal> and <literal>&lt;outputRef&gt;</literal> (children of the <literal>&lt;analysis&gt;</literal> element).  Level elements (except for <literal>&lt;project&gt;</literal> and <literal>&lt;subject&gt;</literal>, which are at the top of the experiment hierarchy) can be implicitly linked to ancestor elements using the attributes provided.</para>
    </section>
  </section>

  <section>
    <title>Examples</title>

    <section>
      <title>Metadata hierarchy</title>
      <para>The metadata hierarchy illustrated in <xref linkend='hierarchy.levels'/> can be represented in XCEDE as shown in <xref linkend='hierarchy.example_instance'/> (only those elements/attributes relevant to linking are shown; the actual metadata contents of the elements are omitted for space).</para>
    </section>
    <figure id="hierarchy.example_instance">
      <title>Metadata hierarchy instance</title>
      <programlisting><![CDATA[<XCEDE xmlns="http://www.xcede.org/xcede-2">
  <project ID="A">
    <projectInfo>
      <subjectGroupList>
        <subjectGroup ID="X">
          <subjectID>1</subjectID>
          <subjectID>2</subjectID>
        </subjectGroup>
      </subjectGroupList>
    </projectInfo>
  </project>
  <project ID="B">
    <projectInfo>
      <subjectGroupList>
        <subjectGroup ID="Z">
          <subjectID>3</subjectID>
        </subjectGroup>
      </subjectGroupList>
    </projectInfo>
  </project>
  <subject ID="1" />
  <subject ID="2" />
  <subject ID="3" />
  <visit ID="1"
         projectID="A" subjectID="1" subjectGroupID="X" />
  <study ID="MR scan"
         projectID="A" subjectID="1" subjectGroupID="X" visitID="1" />
  <episode ID="task run 1"
         projectID="A" subjectID="1" subjectGroupID="X" visitID="1" studyID="MR" />
  <acquisition ID="MR image"
         projectID="A" subjectID="1" subjectGroupID="X" visitID="1" studyID="MR"
         episodeID="task run 1" />
  <acquisition ID="behavioral data"
         projectID="A" subjectID="1" subjectGroupID="X" visitID="1" studyID="MR"
         episodeID="task run 1" />
  <acquisition ID="heart rate"
         projectID="A" subjectID="1" subjectGroupID="X" visitID="1" studyID="MR"
         episodeID="task run 1" />
  <study ID="Clinical interview"
         projectID="A" subjectID="1" subjectGroupID="X" visitID="2" />
  <!-- ... etc. ... -->
</XCEDE>
]]></programlisting>
    </figure>
    <para></para>
  </section>

</chapter>
